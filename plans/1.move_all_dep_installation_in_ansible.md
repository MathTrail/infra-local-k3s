Перенос этих инструментов в Ansible — отличный ход. Мы заменим разрозненные Bash-команды на декларативные роли. Это гарантирует, что на твоей системе всегда будут именно те версии инструментов, которые нужны проекту.

Ниже план реализации для твоего репозитория infra-local-k3s.

1. Подготовка структуры Ansible
Создадим базовую структуру ролей в папке ansible/:

Plaintext
ansible/
├── inventory.yml             # Указываем localhost
├── playbooks/
│   └── install_tools.yml     # Главный плейбук
└── roles/
    ├── nodejs/               # Роль для Node.js
    ├── k3d/                  # Роль для k3d
    └── buildah/              # Роль для buildah
2. Логика ролей (что прописать в задачах)
Роль nodejs (используем Nodesource для актуальных версий)
Вместо ручного скачивания скриптов, Ansible добавит репозиторий и установит пакет:

Task: Добавление GPG-ключа Nodesource.

Task: Добавление репозитория (например, v20.x или v22.x).

Task: Установка nodejs через apt.

Роль k3d (установка бинарника)
Task: Проверка текущей версии (k3d --version).

Task: Если версии нет или она устарела — скачивание бинарника с GitHub Releases.

Task: Установка прав 0755 и перенос в /usr/local/bin/.

Роль buildah (системный пакет)
Task: Установка через стандартный менеджер пакетов apt (в Ubuntu 24.04 он в официальных репозиториях).

Task: Проверка конфигурации /etc/containers/registries.conf (важно для локальных реестров в k3s).

3. Пример кода задачи для k3d (идемпотентный подход)
Вот как это выглядит в Ansible, чтобы не качать файл каждый раз:

YAML
- name: Check if k3d is installed
  command: k3d --version
  register: k3d_check
  ignore_errors: true
  changed_when: false

- name: Install k3d if not present
  get_url:
    url: https://github.com/k3d-io/k3d/releases/download/v5.6.3/k3d-linux-amd64
    dest: /usr/local/bin/k3d
    mode: '0755'
  when: k3d_check.failed
4. Обновление justfile
Теперь твоя команда install превращается в одну элегантную строчку:

Makefile
# В начале justfile
[private]
_check-ansible:
    @ansible --version || (echo "❌ Ansible not found. Install it first: sudo apt install ansible" && exit 1)

# Установка инструментов через Ansible
install: _check-ansible
    ansible-playbook ansible/playbooks/install_tools.yml --ask-become-pass
План для Claude (ТЗ на генерацию кода)
Скопируй этот запрос для Claude, чтобы получить готовые файлы:

"Создай Ansible-плейбук и роли для установки следующих инструментов на Ubuntu:

Node.js (через официальный репозиторий Nodesource, версия 20 или 22).

k3d (скачивание бинарника с GitHub, проверка версии перед установкой).

buildah (установка через стандартный apt).

Требования:

Используй структуру ролей: roles/nodejs, roles/k3d, roles/buildah.

Все задачи должны быть идемпотентными (не выполнять действия, если инструмент уже установлен нужной версии).

Подготовь файл ansible/inventory.yml для работы с localhost.

Файл плейбука install_tools.yml должен объединять все три роли."

Почему это лучше твоего текущего решения:
Версионность: Ты жестко фиксируешь версию k3d в переменных Ansible. Когда выйдет новая, ты просто поменяешь одну цифру в vars.

Чистота системы: Ansible корректно управляет зависимостями (например, nodejs потянет за собой нужные библиотеки через apt).

Логирование: Ты видишь в консоли статус по каждому инструменту: ok (уже есть) или changed (установлено).